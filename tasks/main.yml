---
# tasks file for lae.netbox
- include: check_mandatory_vars.yml

- name: Gather OS specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution|lower }}-{{ ansible_distribution_version }}.yml"
    - "{{ ansible_distribution|lower }}-{{ ansible_distribution_major_version }}.yml"
    - "{{ ansible_distribution|lower }}.yml"
    - "{{ ansible_os_family|lower }}.yml"

- include: check_mandatory_vars.yml

- name: Install EPEL repository
  yum:
    name: epel-release
    state: installed
  when:
    - ansible_pkg_mgr == "yum"
    - netbox_python == 3

- name: Install NetBox dependencies
  package:
    name: "{{ item }}"
    state: installed
  with_items: "{{ netbox_packages }}"

- name: Install Python 2
  package:
    name: "{{ item }}"
    state: installed
  with_items: "{{ netbox_python2_packages }}"
  when: netbox_python == 2

- name: Install Python 3
  package:
    name: "{{ item }}"
    state: installed
  with_items: "{{ netbox_python3_packages }}"
  when: netbox_python == 3

- name: Install virtualenv via pip
  pip:
    name: virtualenv
    state: latest
    executable: "{{ netbox_pip3_binary if (netbox_python == 3) else netbox_pip2_binary }}"

- name: Configure netbox group
  group:
    name: "{{ netbox_group }}"

- name: Configure netbox user
  user:
    name: "{{ netbox_user }}"
    group: "{{ netbox_group }}"
    home: "{{ netbox_home }}"

- block:
  - name: Ensure Postgres database exists (via socket)
    postgresql_db:
      name: "{{ netbox_database }}"
      login_user: "{{ netbox_database_user }}"
      login_unix_socket: "{{ netbox_database_socket }}"
    become: True
    become_user: "{{ netbox_database_user }}"
  when:
    - netbox_database_socket is defined
    - netbox_database_host is not defined

- name: Ensure Postgres database exists (via TCP)
  postgresql_db:
    name: "{{ netbox_database }}"
    login_host: "{{ netbox_database_host }}"
    login_port: "{{ netbox_database_port }}"
    login_user: "{{ netbox_database_user }}"
    login_password: "{{ netbox_database_password }}"
  when:
    - netbox_database_socket is not defined
    - netbox_database_host is not defined

- name: Create directories for NetBox deployment
  file: 
    path: "{{ item }}" 
    state: directory
    owner: "{{ netbox_user }}"
    group: "{{ netbox_group }}"
  with_items:
    - "{{ netbox_releases_path }}"
    - "{{ netbox_shared_path }}"
    - "{{ netbox_git_path }}"

- include: download_netbox_tarball.yml
  when: netbox_stable == true

- name: Install Netbox python dependencies inside active virtualenv
  pip:
    requirements: "{{ netbox_current_path }}/requirements.txt"
    virtualenv: "{{ netbox_current_path }}/venv-py{{ netbox_python }}"
    virtualenv_python: "{{ netbox_python3_binary if (netbox_python == 3) else netbox_python2_binary }}"
  when: netbox_stable
